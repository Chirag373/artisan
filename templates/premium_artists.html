{% extends 'base.html' %}

{% block title %}Premium Artists - ArtistaHub{% endblock %}

{% block content %}

<div class="relative z-20 container mx-auto -mt-8 mb-12">
    <div
        class="bg-gradient-to-r from-amber-50 via-yellow-50 to-amber-50 backdrop-blur-md rounded-2xl border-2 border-amber-300 p-8 shadow-xl">
        <div class="flex flex-col items-center justify-center space-y-4">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
                <h1
                    class="text-4xl font-bold bg-gradient-to-r from-amber-600 to-yellow-600 bg-clip-text text-transparent">
                    Premium Artists</h1>
                <svg class="w-8 h-8 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
            </div>
            <p class="text-xl text-gray-700 text-center max-w-3xl">
                Discover our handpicked selection of exceptional artists with verified portfolios
            </p>
        </div>
    </div>
</div>

<div class="container mx-auto">
    <div id="premium-artists-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16 px-0 md:px-0">
        <div class="col-span-full text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-amber-600"></div>
            <p class="mt-2 text-gray-500">Loading premium artists...</p>
        </div>
    </div>
</div>

<div id="toast"
    class="fixed bottom-6 right-6 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-32 transition-transform duration-300 ease-out flex items-center gap-3 z-50">
    <svg class="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
    </svg>
    <span class="font-medium">Action completed!</span>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;

    document.addEventListener('DOMContentLoaded', async () => {
        await loadPremiumArtists();
        setupInfiniteScroll();
    });

    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        const toastText = toast.querySelector('span');
        const toastIcon = toast.querySelector('svg');

        toastText.textContent = message;

        if (isError) {
            toastIcon.classList.remove('text-green-400');
            toastIcon.classList.add('text-red-400');
        } else {
            toastIcon.classList.remove('text-red-400');
            toastIcon.classList.add('text-green-400');
        }

        toast.classList.remove('translate-y-32');
        toast.classList.add('translate-y-0');

        setTimeout(() => {
            toast.classList.remove('translate-y-0');
            toast.classList.add('translate-y-32');
        }, 3000);
    }

    function createSkeletonCard() {
        return `
            <article class="skeleton-card bg-[#FEFCE8] rounded-none md:rounded-2xl border-y border-x-0 border-gray-400 md:border md:border-purple-300 shadow-lg flex flex-col h-full overflow-hidden animate-pulse">
                <div class="relative h-48 w-full bg-gray-200"></div>
                <div class="px-2 md:px-6 pb-6 flex flex-col flex-grow relative">
                    <div class="-mt-10 mb-3">
                        <div class="w-20 h-20 rounded-2xl bg-gray-200 border-4 border-[#FEFCE8]"></div>
                    </div>
                    <div class="mb-3">
                        <div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <div class="h-6 bg-gray-200 rounded w-16"></div>
                        <div class="h-6 bg-gray-200 rounded w-20"></div>
                    </div>
                    <div class="mb-6">
                        <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                    </div>
                    <div class="mt-auto pt-4">
                        <div class="h-32 bg-gray-200 rounded-lg w-full mb-3"></div>
                        <div class="h-10 bg-gray-200 rounded-lg w-full"></div>
                    </div>
                </div>
            </article>
        `;
    }

    function showLoadingCards(count = 6) {
        const grid = document.getElementById('premium-artists-grid');
        const skeletons = Array(count).fill(null).map(() => createSkeletonCard()).join('');
        grid.insertAdjacentHTML('beforeend', skeletons);
    }

    function removeLoadingCards() {
        document.querySelectorAll('.skeleton-card').forEach(card => card.remove());
    }

    async function loadPremiumArtists() {
        if (isLoading || !hasMore) return;

        isLoading = true;
        const grid = document.getElementById('premium-artists-grid');

        try {
            if (currentPage === 1) {
                grid.innerHTML = '';
            }
            showLoadingCards();

            // Add 3 second delay
            await new Promise(resolve => setTimeout(resolve, 3000));

            // Build API URL with pagination
            const params = new URLSearchParams();
            params.set('page', currentPage);
            params.set('page_size', 6);
            params.set('featured_only', 'true'); // Get only featured/premium artists
            const apiEndpoint = '/api/featured-artists/?' + params.toString();

            const response = await fetch(apiEndpoint);
            if (!response.ok) throw new Error('Failed to fetch premium artists');

            const data = await response.json();
            const artists = data.results || data;

            removeLoadingCards();

            if (artists.length === 0 && currentPage === 1) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-gray-500 text-lg">No premium artists available at the moment.</p>
                        <a href="/" class="mt-4 inline-block text-purple-600 hover:underline">Browse All Artists</a>
                    </div>
                `;
                hasMore = false;
                isLoading = false;
                return;
            }

            hasMore = data.has_more !== undefined ? data.has_more : false;

            // Create premium artist cards
            const artistsHTML = artists.map(artist => {
                // Get up to 8 portfolio images
                const portfolioImages = (artist.portfolio_images || []).slice(0, 8);
                const hasPortfolio = portfolioImages.length > 0;

                return `
                <article class="group bg-[#FEFCE8] rounded-none md:rounded-2xl border-y border-x-0 border-gray-400 md:border md:border-gray-400 shadow-lg hover:shadow-2xl hover:shadow-gray-300/50 transition-all duration-500 flex flex-col h-full overflow-hidden transform hover:-translate-y-1">
                    <!-- Banner Image with Gradient Overlay -->
                    <div class="relative h-48 w-full overflow-hidden bg-gray-100">
                        <img src="${artist.banner_image || 'https://images.unsplash.com/photo-1579783902614-a3fb39279c0f?q=80&w=800&auto=format&fit=crop'}"
                            alt="Cover" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                        <div class="absolute inset-0 bg-gradient-to-t from-gray-900/20 to-transparent"></div>
                        
                        <!-- Premium Badge -->
                        <div class="absolute top-4 right-4">
                            <span class="bg-gradient-to-r from-amber-500 to-yellow-500 text-gray-900 text-xs font-bold px-4 py-2 rounded-full shadow-lg flex items-center gap-2 border-2 border-yellow-600">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                PREMIUM
                            </span>
                        </div>
                    </div>

                    <div class="px-2 md:px-6 pb-6 flex flex-col flex-grow relative">
                        <!-- Profile Image -->
                        <div class="-mt-10 mb-3 flex justify-between items-end">
                            <div class="relative">
                                <img src="${artist.profile_image || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(artist.artist_name)}"
                                    class="w-20 h-20 rounded-2xl border-4 border-[#FEFCE8] shadow-xl object-cover bg-white ring-2 ring-yellow-400"
                                    alt="${artist.artist_name}">
                                <div class="absolute -bottom-1 -right-1 bg-gradient-to-r from-amber-500 to-yellow-500 text-gray-900 w-7 h-7 rounded-full border-2 border-[#FEFCE8] shadow-sm flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Artist Info -->
                        <div class="mb-3">
                            <h3 class="text-lg font-bold text-gray-900 group-hover:text-blue-600 transition-colors flex items-center gap-2">
                                ${artist.artist_name}
                            </h3>
                            <p class="text-sm text-gray-600 flex items-center gap-2">
                                <span>${artist.location_city || 'Unknown'}, ${artist.location_state || ''}</span>
                                ${artist.rating ? `
                                <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                                <span class="text-amber-500 flex items-center gap-0.5 text-xs font-medium">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                    </svg>
                                    ${artist.rating}
                                </span>
                                ` : ''}
                            </p>
                        </div>

                        <!-- Categories -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${(artist.categories || []).slice(0, 3).map(cat => `
                                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors cursor-default">
                                    ${cat.replace('_', ' ')}
                                </span>
                            `).join('')}
                        </div>

                        <!-- Bio -->
                        <div class="text-gray-600 text-sm mb-4 leading-relaxed line-clamp-2">
                            ${artist.short_bio ? `
                                <p>${artist.short_bio}</p>
                            ` : `
                                <p>${artist.full_bio && artist.full_bio.length > 100
                        ? artist.full_bio.substring(0, 100) + '...'
                        : (artist.full_bio || 'No bio available.')}</p>
                            `}
                        </div>

                        <!-- Portfolio Preview Grid (8 images behind View Profile) -->
                        <div class="mt-auto">
                            ${hasPortfolio ? `
                            <div class="mb-3 relative rounded-xl overflow-hidden border-2 border-gray-300 bg-white shadow-inner h-40">
                                <div class="grid grid-cols-4 grid-rows-2 gap-0.5 h-full w-full">
                                    ${portfolioImages.map((img, idx) => `
                                        <div class="relative overflow-hidden bg-gray-100 group/img">
                                            <img src="${img.image}" 
                                                class="w-full h-full object-cover hover:scale-110 transition-transform duration-300" 
                                                alt="${img.caption || 'Portfolio'}"
                                                onerror="this.src='https://via.placeholder.com/150?text=Image'">
                                        </div>
                                    `).join('')}
                                    ${portfolioImages.length < 8 ? Array(8 - portfolioImages.length).fill(0).map(() => `
                                        <div class="bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center">
                                            <svg class="w-4 h-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </div>
                                    `).join('') : ''}
                                </div>
                                <div class="absolute inset-0 bg-gradient-to-t from-gray-900/10 to-transparent pointer-events-none"></div>
                            </div>
                            ` : `
                            <div class="mb-3 rounded-xl overflow-hidden border-2 border-dashed border-gray-300 bg-gradient-to-br from-gray-50 to-gray-100 h-40 flex flex-col items-center justify-center p-4">
                                <div class="text-center">
                                    <svg class="w-10 h-10 text-gray-300 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <p class="text-xs text-gray-500 font-medium">No Portfolio Images</p>
                                </div>
                            </div>
                            `}

                            <!-- View Profile Button -->
                            <div class="flex gap-2 items-center border-t border-gray-200 pt-4">
                                <a href="/artist/${artist.slug}/"
                                    class="flex-1 inline-flex items-center justify-center px-4 py-2.5 bg-[#FEFCE8] border border-gray-400 hover:border-blue-500 hover:text-blue-600 text-gray-700 text-sm font-semibold rounded-lg transition-all">
                                    View Profile
                                </a>
                                <button class="bookmark-btn hidden flex-shrink-0 inline-flex items-center justify-center p-2.5 bg-white border border-gray-200 hover:border-red-500 rounded-lg transition-all" data-slug="${artist.slug}">
                                    <svg class="bookmark-icon-outline w-5 h-5 text-gray-600" fill="none" viewBox="0 0 20 20" stroke="currentColor" stroke-width="2">
                                        <path d="M5 5a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 19V5z" />
                                    </svg>
                                    <svg class="bookmark-icon-filled hidden w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M5 5a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 19V5z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </article>
            `;
            }).join('');

            grid.insertAdjacentHTML('beforeend', artistsHTML);
            currentPage++;

            // Setup bookmarks for explorers
            setupBookmarks();

        } catch (error) {
            console.error('Error loading premium artists:', error);
            removeLoadingCards();
            if (currentPage === 1) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-red-500">Failed to load premium artists. Please try again later.</p>
                    </div>
                `;
            }
        } finally {
            isLoading = false;
        }
    }

    function setupInfiniteScroll() {
        let scrollTimeout;

        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);

            scrollTimeout = setTimeout(() => {
                const scrollPosition = window.innerHeight + window.scrollY;
                const pageHeight = document.documentElement.scrollHeight;

                if (scrollPosition >= pageHeight - 300 && !isLoading && hasMore) {
                    loadPremiumArtists();
                }
            }, 100);
        });
    }

    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function setupBookmarks() {
        const role = localStorage.getItem('user_role');

        // Only show bookmarks for explorers
        if (role !== 'explorer') {
            return;
        }

        const csrftoken = getCookie('csrftoken');
        const bookmarkButtons = document.querySelectorAll('.bookmark-btn:not([data-initialized="true"])');

        if (bookmarkButtons.length === 0) return;

        bookmarkButtons.forEach(btn => {
            btn.classList.remove('hidden');
            btn.setAttribute('data-initialized', 'true');

            btn.addEventListener('click', async function (e) {
                e.preventDefault();
                e.stopPropagation();

                const slug = this.getAttribute('data-slug');
                const outlineIcon = this.querySelector('.bookmark-icon-outline');
                const filledIcon = this.querySelector('.bookmark-icon-filled');
                const wasBookmarked = this.classList.contains('bookmarked');

                // Optimistic UI Update
                if (wasBookmarked) {
                    outlineIcon.classList.remove('hidden');
                    filledIcon.classList.add('hidden');
                    this.classList.remove('bookmarked');
                } else {
                    outlineIcon.classList.add('hidden');
                    filledIcon.classList.remove('hidden');
                    this.classList.add('bookmarked');
                }

                try {
                    const response = await fetch(`/api/bookmarks/toggle/${slug}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();

                        if (data.is_bookmarked) {
                            outlineIcon.classList.add('hidden');
                            filledIcon.classList.remove('hidden');
                            this.classList.add('bookmarked');
                            showToast('Artist bookmarked!', false);
                        } else {
                            outlineIcon.classList.remove('hidden');
                            filledIcon.classList.add('hidden');
                            this.classList.remove('bookmarked');
                            showToast('Bookmark removed', false);
                        }
                    } else {
                        throw new Error('Request failed');
                    }
                } catch (error) {
                    console.error('Error toggling bookmark:', error);
                    // Revert UI
                    if (wasBookmarked) {
                        outlineIcon.classList.add('hidden');
                        filledIcon.classList.remove('hidden');
                        this.classList.add('bookmarked');
                    } else {
                        outlineIcon.classList.remove('hidden');
                        filledIcon.classList.add('hidden');
                        this.classList.remove('bookmarked');
                    }
                    showToast('An error occurred', true);
                }
            });
        });

        // Fetch bookmark states for new buttons
        for (const btn of bookmarkButtons) {
            const slug = btn.getAttribute('data-slug');
            try {
                const response = await fetch(`/api/bookmarks/check/${slug}/`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.is_bookmarked) {
                        btn.querySelector('.bookmark-icon-outline').classList.add('hidden');
                        btn.querySelector('.bookmark-icon-filled').classList.remove('hidden');
                        btn.classList.add('bookmarked');
                    }
                }
            } catch (error) {
                console.error('Error checking bookmark status:', error);
            }
        }
    }
</script>
{% endblock %}