{% extends 'custom_admin/base.html' %}

{% block title %}Plan Pricing - Admin{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900">Plan Pricing</h1>
    <p class="text-gray-500 mt-1">Manage subscription plan prices</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    {% for plan in plans %}
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div class="p-6 border-b border-gray-200 {% if plan.plan_name == 'premium' %}bg-gradient-to-r from-purple-500 to-blue-500{% elif plan.plan_name == 'express' %}bg-blue-500{% else %}bg-gray-100{% endif %}">
            <h3 class="text-lg font-bold {% if plan.plan_name != 'basic' %}text-white{% else %}text-gray-900{% endif %} capitalize">{{ plan.plan_name }}</h3>
            <p class="text-3xl font-bold {% if plan.plan_name != 'basic' %}text-white{% else %}text-gray-900{% endif %} mt-2">
                ${{ plan.price_dollars|floatformat:2 }}<span class="text-sm font-normal opacity-75">/mo</span>
            </p>
        </div>
        <form class="p-6 space-y-4 plan-form" data-plan-id="{{ plan.id }}">
            {% csrf_token %}
            <input type="hidden" name="plan_id" value="{{ plan.id }}">
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Price (USD)</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                    <input type="number" name="price" value="{{ plan.price_dollars|floatformat:2 }}" step="0.01" min="0"
                        class="w-full pl-8 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-sm">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea name="description" rows="2"
                    class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-sm resize-none">{{ plan.description }}</textarea>
            </div>
            
            <button type="submit"
                class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition">
                Update Price
            </button>
        </form>
    </div>
    {% endfor %}
</div>

<div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-xl p-6">
    <div class="flex gap-3">
        <svg class="w-6 h-6 text-yellow-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <div>
            <h4 class="font-semibold text-yellow-800">Important Note</h4>
            <p class="text-sm text-yellow-700 mt-1">
                Changing prices here updates the database records. To reflect these changes in Stripe checkout, 
                you'll also need to update the pricing in your Stripe dashboard or update the StripeService code 
                to fetch prices from the database.
            </p>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-6 right-6 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-32 transition-transform duration-300 flex items-center gap-3 z-50">
    <svg class="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
    </svg>
    <span id="toast-text">Price updated successfully</span>
</div>
{% endblock %}

{% block scripts %}
<script>
function showToast(message, isError = false) {
    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toast-text');
    const icon = toast.querySelector('svg');
    
    toastText.textContent = message;
    icon.classList.toggle('text-green-400', !isError);
    icon.classList.toggle('text-red-400', isError);
    
    toast.classList.remove('translate-y-32');
    setTimeout(() => toast.classList.add('translate-y-32'), 3000);
}

document.querySelectorAll('.plan-form').forEach(form => {
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch('{% url "custom_admin:plan_pricing" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Price updated successfully');
            } else {
                showToast(result.error || 'Failed to update price', true);
            }
        } catch (error) {
            showToast('An error occurred', true);
        }
    });
});
</script>
{% endblock %}
