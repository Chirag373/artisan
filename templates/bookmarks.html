{% extends 'base.html' %}

{% block content %}
<style>
    .hero-banner {
        display: none !important;
    }
</style>

<div class="container mx-auto">
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">My Bookmarks</h1>
            <p class="text-gray-600">Artists you've saved for later</p>
        </div>
    </div>

    <div id="bookmarks-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16 px-0 md:px-0">
        <div class="col-span-full text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
            <p class="mt-2 text-gray-500">Loading bookmarks...</p>
        </div>
    </div>
</div>

<div id="toast"
    class="fixed bottom-6 right-6 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-32 transition-transform duration-300 ease-out flex items-center gap-3 z-50">
    <svg class="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
    </svg>
    <span class="font-medium">Action completed!</span>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const grid = document.getElementById('bookmarks-grid');

        // Helper to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastText = toast.querySelector('span');
            const toastIcon = toast.querySelector('svg');

            toastText.textContent = message;

            if (isError) {
                toastIcon.classList.remove('text-green-400');
                toastIcon.classList.add('text-red-400');
            } else {
                toastIcon.classList.remove('text-red-400');
                toastIcon.classList.add('text-green-400');
            }

            toast.classList.remove('translate-y-32');
            toast.classList.add('translate-y-0');

            setTimeout(() => {
                toast.classList.remove('translate-y-0');
                toast.classList.add('translate-y-32');
            }, 3000);
        }

        // Function to toggle bookmark
        async function toggleBookmark(slug, cardElement) {
            try {
                const response = await fetch(`/api/bookmarks/toggle/${slug}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (!data.is_bookmarked) {
                        showToast('Bookmark removed', false);
                        // Remove the card with fade out animation
                        cardElement.style.opacity = '0';
                        cardElement.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            cardElement.remove();
                            // Check if grid is empty
                            const remainingCards = grid.querySelectorAll('article');
                            if (remainingCards.length === 0) {
                                grid.innerHTML = `
                                    <div class="col-span-full text-center py-12">
                                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                                        </svg>
                                        <p class="text-gray-500 text-lg mb-4">No bookmarks yet</p>
                                        <a href="/" class="text-blue-600 hover:underline">Browse artists to bookmark</a>
                                    </div>
                                `;
                            }
                        }, 300);
                    }
                }
            } catch (error) {
                console.error('Error toggling bookmark:', error);
            }
        }

        // Load bookmarks
        try {
            const response = await fetch('/api/bookmarks/');
            if (!response.ok) throw new Error('Failed to fetch bookmarks');

            const data = await response.json();
            const artists = data.results || [];

            grid.innerHTML = '';

            if (artists.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                        </svg>
                        <p class="text-gray-500 text-lg mb-4">No bookmarks yet</p>
                        <a href="/" class="text-blue-600 hover:underline">Browse artists to bookmark</a>
                    </div>
                `;
                return;
            }

            const artistsHTML = artists.map(artist => `
                <article class="group bg-[#FEFCE8] rounded-none md:rounded-2xl border-y border-x-0 border-gray-400 md:border md:border-gray-400 shadow-sm hover:shadow-[0_8px_30px_rgb(0,0,0,0.04)] transition-all duration-300 flex flex-col h-full overflow-hidden" style="transition: opacity 0.3s, transform 0.3s">
                    <div class="relative h-40 w-full overflow-hidden bg-gray-100">
                        <img src="${artist.banner_image || 'https://images.unsplash.com/photo-1579783902614-a3fb39279c0f?q=80&w=800&auto=format&fit=crop'}"
                            alt="Cover" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                        ${artist.is_featured ? `
                        <div class="absolute top-4 right-4">
                            <span class="bg-white/90 backdrop-blur text-xs font-bold text-indigo-600 px-3 py-1 rounded-full shadow-sm flex items-center gap-1">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                Featured
                            </span>
                        </div>
                        ` : ''}
                    </div>

                    <div class="px-2 md:px-6 pb-6 flex flex-col flex-grow relative">
                        <div class="-mt-10 mb-3 flex justify-between items-end">
                            <div class="relative">
                                <img src="${artist.profile_image || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(artist.artist_name)}"
                                    class="w-20 h-20 rounded-2xl border-4 border-[#FEFCE8] shadow-md object-cover bg-[#FEFCE8]"
                                    alt="${artist.artist_name}">
                            </div>
                        </div>

                        <div class="mb-3">
                            <h3 class="text-lg font-bold text-gray-900 group-hover:text-blue-600 transition-colors flex items-center gap-1">
                                ${artist.artist_name}
                            </h3>
                            <p class="text-sm text-gray-500 flex items-center gap-2">
                                <span>${artist.location_city || 'Unknown'}, ${artist.location_state || ''}</span>
                                ${artist.rating ? `
                                <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                                <span class="text-amber-500 flex items-center gap-0.5 text-xs font-medium">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                    </svg>
                                    ${artist.rating}
                                </span>
                                ` : ''}
                            </p>
                        </div>

                        <div class="flex flex-wrap gap-2 mb-4">
                            ${(artist.categories || []).slice(0, 3).map(cat => `
                                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors cursor-default">
                                    ${cat.replace('_', ' ')}
                                </span>
                            `).join('')}
                        </div>

                        <div class="text-gray-600 text-sm mb-6 leading-relaxed">
                            <p class="bio-text">
                                ${artist.full_bio && artist.full_bio.length > 120
                    ? artist.full_bio.substring(0, 120) + '...'
                    : (artist.full_bio || 'No bio available.')}
                            </p>
                        </div>

                        <div class="mt-auto pt-4 border-t border-gray-50">
                            <div class="flex gap-2 items-center">
                                <a href="/artist/${artist.slug}/"
                                    class="flex-1 inline-flex items-center justify-center px-4 py-2.5 bg-[#FEFCE8] border border-gray-200 hover:border-blue-500 hover:text-blue-600 text-gray-700 text-sm font-semibold rounded-lg transition-all" style="flex-basis: 80%">
                                    View Profile
                                </a>
                                <button class="bookmark-btn flex-shrink-0 inline-flex items-center justify-center p-2.5 bg-white border border-gray-200 hover:border-red-500 rounded-lg transition-all" style="flex-basis: 20%" data-slug="${artist.slug}">
                                    <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M5 5a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 19V5z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </article>
            `).join('');

            grid.innerHTML = artistsHTML;

            // Add bookmark toggle listeners
            document.querySelectorAll('.bookmark-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const slug = this.getAttribute('data-slug');
                    const card = this.closest('article');
                    toggleBookmark(slug, card);
                });
            });

        } catch (error) {
            console.error('Error loading bookmarks:', error);
            grid.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <p class="text-red-500">Failed to load bookmarks. Please try again later.</p>
                </div>
            `;
        }
    });
</script>
{% endblock %}