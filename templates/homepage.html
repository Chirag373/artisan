{% extends 'base.html' %}

{% block content %}

<div class="relative z-20 container mx-auto -mt-8 mb-12">
    <div class="bg-[#FEFCE8]/80 backdrop-blur-md rounded-2xl border border-gray-400 p-6">
        <form action="" method="GET" class="space-y-4 md:space-y-0 md:flex md:gap-4">
            <div class="flex-grow relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <input type="text" name="q" id="keywords"
                    class="block w-full pl-11 pr-4 py-4 bg-gray-50 border-transparent rounded-xl text-gray-900 placeholder-gray-500 focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-200"
                    placeholder="What are you looking for? (e.g. Pokemon, Digital Art)...">
            </div>

            <div class="w-full md:w-1/3 relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
                <input type="text" name="location" id="location"
                    class="block w-full pl-11 pr-4 py-4 bg-gray-50 border-transparent rounded-xl text-gray-900 placeholder-gray-500 focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-200"
                    placeholder="City or Zip">
            </div>

            <button type="submit"
                class="w-full md:w-auto px-8 py-4 bg-gray-900 hover:bg-black text-white font-medium rounded-xl shadow-lg shadow-gray-900/10 transform hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2">
                <span>Search</span>
            </button>
        </form>
    </div>
</div>

<div class="container mx-auto">
    <div id="featured-artists-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16 px-0 md:px-0">
        <div class="col-span-full text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
            <p class="mt-2 text-gray-500">Loading artists...</p>
        </div>
    </div>
</div>

<div id="toast"
    class="fixed bottom-6 right-6 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-32 transition-transform duration-300 ease-out flex items-center gap-3 z-50">
    <svg class="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
    </svg>
    <span class="font-medium">Action completed!</span>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;
    let searchParams = '';

    document.addEventListener('DOMContentLoaded', async () => {
        const grid = document.getElementById('featured-artists-grid');

        // Get query parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');
        const location = urlParams.get('location');
        searchParams = window.location.search;

        // Pre-fill search inputs if params exist
        if (query) document.getElementById('keywords').value = query;
        if (location) document.getElementById('location').value = location;

        // Load initial artists
        await loadArtists();

        // Setup infinite scroll
        setupInfiniteScroll();
    });

    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        const toastText = toast.querySelector('span');
        const toastIcon = toast.querySelector('svg');

        toastText.textContent = message;

        if (isError) {
            toastIcon.classList.remove('text-green-400');
            toastIcon.classList.add('text-red-400');
        } else {
            toastIcon.classList.remove('text-red-400');
            toastIcon.classList.add('text-green-400');
        }

        toast.classList.remove('translate-y-32');
        toast.classList.add('translate-y-0');

        setTimeout(() => {
            toast.classList.remove('translate-y-0');
            toast.classList.add('translate-y-32');
        }, 3000);
    }

    function createSkeletonCard() {
        return `
            <article class="skeleton-card bg-[#FEFCE8] rounded-none md:rounded-2xl border-y border-x-0 border-gray-400 md:border md:border-gray-400 shadow-sm flex flex-col h-full overflow-hidden animate-pulse">
                <div class="relative h-40 w-full bg-gray-200"></div>
                <div class="px-2 md:px-6 pb-6 flex flex-col flex-grow relative">
                    <div class="-mt-10 mb-3">
                        <div class="w-28 h-16 rounded-xl bg-gray-200 border-4 border-[#FEFCE8]"></div>
                    </div>
                    <div class="mb-3">
                        <div class="h-5 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <div class="h-6 bg-gray-200 rounded w-16"></div>
                        <div class="h-6 bg-gray-200 rounded w-20"></div>
                    </div>
                    <div class="mb-6">
                        <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                    </div>
                    <div class="mt-auto pt-4">
                        <div class="h-10 bg-gray-200 rounded-lg w-full"></div>
                    </div>
                </div>
            </article>
        `;
    }

    function showLoadingCards(count = 6) {
        const grid = document.getElementById('featured-artists-grid');
        const skeletons = Array(count).fill(null).map(() => createSkeletonCard()).join('');
        grid.insertAdjacentHTML('beforeend', skeletons);
    }

    function removeLoadingCards() {
        document.querySelectorAll('.skeleton-card').forEach(card => card.remove());
    }

    async function loadArtists() {
        if (isLoading || !hasMore) return;

        isLoading = true;
        const grid = document.getElementById('featured-artists-grid');

        try {
            // Show loading skeletons
            if (currentPage === 1) {
                grid.innerHTML = '';
            }
            showLoadingCards();

            // Add 3 second delay
            await new Promise(resolve => setTimeout(resolve, 3000));

            // Build API URL with pagination
            const params = new URLSearchParams(searchParams);
            params.set('page', currentPage);
            params.set('page_size', 6);
            const apiEndpoint = '/api/featured-artists/?' + params.toString();

            const response = await fetch(apiEndpoint);
            if (!response.ok) throw new Error('Failed to fetch artists');

            const data = await response.json();
            const artists = data.results || data;

            // Remove loading skeletons
            removeLoadingCards();

            if (artists.length === 0 && currentPage === 1) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-gray-500 text-lg">No artists found matching your criteria.</p>
                        <a href="/" class="mt-4 inline-block text-blue-600 hover:underline">Clear Search</a>
                    </div>
                `;
                hasMore = false;
                isLoading = false;
                return;
            }

            // Update hasMore flag
            hasMore = data.has_more !== undefined ? data.has_more : false;

            // Append new artists to grid
            const artistsHTML = artists.map(artist => `
                <article class="group bg-[#FEFCE8] rounded-none md:rounded-2xl border-y border-x-0 border-gray-400 md:border md:border-gray-400 shadow-sm hover:shadow-[0_8px_30px_rgb(0,0,0,0.04)] transition-all duration-300 flex flex-col h-full overflow-hidden">
                    <div class="relative h-40 w-full overflow-hidden bg-gray-100">
                        <img src="${artist.banner_image || 'https://images.unsplash.com/photo-1579783902614-a3fb39279c0f?q=80&w=800&auto=format&fit=crop'}"
                            alt="Cover" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                        ${artist.is_featured ? `
                        <div class="absolute top-4 right-4">
                            <span class="bg-white/90 backdrop-blur text-xs font-bold text-indigo-600 px-3 py-1 rounded-full shadow-sm flex items-center gap-1">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                Featured
                            </span>
                        </div>
                        ` : ''}
                    </div>

                    <div class="px-2 md:px-6 pb-6 flex flex-col flex-grow relative">
                        <div class="-mt-10 mb-3 flex justify-between items-end">
                            <div class="relative">
                                <img src="${artist.profile_image || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(artist.artist_name)}"
                                    class="w-28 h-auto rounded-xl border-4 border-[#FEFCE8] shadow-md object-contain bg-[#FEFCE8]"
                                    alt="${artist.artist_name}">
                            </div>
                        </div>

                        <div class="mb-3">
                            <h3 class="text-lg font-bold text-gray-900 group-hover:text-blue-600 transition-colors flex items-center gap-1 break-words">
                                ${artist.artist_name}
                            </h3>
                            <p class="text-sm text-gray-500 flex items-center gap-2">
                                <span>${artist.location_city || 'Unknown'}, ${artist.location_state || ''}</span>
                                ${artist.rating ? `
                                <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                                <span class="text-amber-500 flex items-center gap-0.5 text-xs font-medium">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                    </svg>
                                    ${artist.rating}
                                </span>
                                ` : ''}
                            </p>
                        </div>

                        <div class="flex flex-wrap gap-2 mb-4">
                            ${(artist.categories || []).slice(0, 3).map(cat => `
                                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors cursor-default">
                                    ${cat.replace('_', ' ')}
                                </span>
                            `).join('')}
                        </div>

                        <div class="text-gray-600 text-sm mb-6 leading-relaxed">
                            ${artist.short_bio ? `
                                <p class="bio-text break-words">${artist.short_bio}</p>
                            ` : `
                                <p class="bio-text break-words" data-full-text="${(artist.full_bio || 'No bio available.').replace(/"/g, '&quot;')}">
                                    ${artist.full_bio && artist.full_bio.length > 120
                    ? artist.full_bio.substring(0, 120) + '...'
                    : (artist.full_bio || 'No bio available.')}
                                </p>
                                ${artist.full_bio && artist.full_bio.length > 120 ? `
                                    <button class="read-more-btn text-blue-600 hover:text-blue-700 font-medium text-xs mt-1 focus:outline-none">
                                        Read More
                                    </button>
                                ` : ''}
                            `}
                        </div>

                        <div class="mt-auto pt-4 border-t border-gray-50">
                            <div class="flex gap-2 items-center">
                                <a href="/artist/${artist.slug}/"
                                    class="flex-1 inline-flex items-center justify-center px-4 py-2.5 bg-[#FEFCE8] border border-gray-200 hover:border-blue-500 hover:text-blue-600 text-gray-700 text-sm font-semibold rounded-lg transition-all" style="flex-basis: 80%">
                                    View Profile
                                </a>
                                <button class="bookmark-btn hidden flex-shrink-0 inline-flex items-center justify-center p-2.5 bg-white border border-gray-200 hover:border-red-500 rounded-lg transition-all" style="flex-basis: 20%" data-slug="${artist.slug}">
                                    <svg class="bookmark-icon-outline w-5 h-5 text-gray-600" fill="none" viewBox="0 0 20 20" stroke="currentColor" stroke-width="2">
                                        <path d="M5 5a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 19V5z" />
                                    </svg>
                                    <svg class="bookmark-icon-filled hidden w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M5 5a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 19V5z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </article>
            `).join('');

            grid.insertAdjacentHTML('beforeend', artistsHTML);

            // Increment page for next load
            currentPage++;

            // Add event listeners for Read More/Less buttons
            document.querySelectorAll('.read-more-btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const bioText = this.previousElementSibling;
                    const fullText = bioText.getAttribute('data-full-text');
                    const isExpanded = this.textContent === 'Read Less';

                    if (isExpanded) {
                        bioText.textContent = fullText.substring(0, 120) + '...';
                        this.textContent = 'Read More';
                    } else {
                        bioText.textContent = fullText;
                        this.textContent = 'Read Less';
                    }
                });
            });

            // Setup bookmarks for explorers
            setupBookmarks();

        } catch (error) {
            console.error('Error loading artists:', error);
            removeLoadingCards();
            if (currentPage === 1) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-red-500">Failed to load artists. Please try again later.</p>
                    </div>
                `;
            }
        } finally {
            isLoading = false;
        }
    }

    function setupInfiniteScroll() {
        let scrollTimeout;

        window.addEventListener('scroll', () => {
            // Clear previous timeout
            clearTimeout(scrollTimeout);

            // Set new timeout to check scroll position
            scrollTimeout = setTimeout(() => {
                const scrollPosition = window.innerHeight + window.scrollY;
                const pageHeight = document.documentElement.scrollHeight;

                // Load more when user is 300px from bottom
                if (scrollPosition >= pageHeight - 300 && !isLoading && hasMore) {
                    loadArtists();
                }
            }, 100);
        });
    }

    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function setupBookmarks() {
        const role = localStorage.getItem('user_role');

        // Only show bookmarks for explorers
        if (role !== 'explorer') {
            return;
        }

        const csrftoken = getCookie('csrftoken');
        // Select only uninitialized buttons to avoid duplicate listeners
        const bookmarkButtons = document.querySelectorAll('.bookmark-btn:not([data-initialized="true"])');

        if (bookmarkButtons.length === 0) return;

        // Show buttons and mark initialized
        bookmarkButtons.forEach(btn => {
            btn.classList.remove('hidden');
            btn.setAttribute('data-initialized', 'true');

            // Add click handler immediately
            btn.addEventListener('click', async function (e) {
                e.preventDefault();
                e.stopPropagation();

                const slug = this.getAttribute('data-slug');
                const outlineIcon = this.querySelector('.bookmark-icon-outline');
                const filledIcon = this.querySelector('.bookmark-icon-filled');
                const wasBookmarked = this.classList.contains('bookmarked');

                // Optimistic UI Update
                if (wasBookmarked) {
                    // Assume unbookmarking
                    outlineIcon.classList.remove('hidden');
                    filledIcon.classList.add('hidden');
                    this.classList.remove('bookmarked');
                } else {
                    // Assume bookmarking
                    outlineIcon.classList.add('hidden');
                    filledIcon.classList.remove('hidden');
                    this.classList.add('bookmarked');
                }

                try {
                    const response = await fetch(`/api/bookmarks/toggle/${slug}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // Verify state matches server
                        if (data.is_bookmarked) {
                            outlineIcon.classList.add('hidden');
                            filledIcon.classList.remove('hidden');
                            this.classList.add('bookmarked');
                            showToast('Artist bookmarked!', false);
                        } else {
                            outlineIcon.classList.remove('hidden');
                            filledIcon.classList.add('hidden');
                            this.classList.remove('bookmarked');
                            showToast('Bookmark removed', false);
                        }
                    } else {
                        // Revert on failure
                        throw new Error('Request failed');
                    }
                } catch (error) {
                    console.error('Error toggling bookmark:', error);
                    // Revert UI
                    if (wasBookmarked) {
                        outlineIcon.classList.add('hidden');
                        filledIcon.classList.remove('hidden');
                        this.classList.add('bookmarked');
                    } else {
                        outlineIcon.classList.remove('hidden');
                        filledIcon.classList.add('hidden');
                        this.classList.remove('bookmarked');
                    }
                    showToast('An error occurred', true);
                }
            });
        });

        // Fetch bookmark states for these new buttons
        for (const btn of bookmarkButtons) {
            const slug = btn.getAttribute('data-slug');
            try {
                const response = await fetch(`/api/bookmarks/check/${slug}/`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.is_bookmarked) {
                        // Show filled icon
                        btn.querySelector('.bookmark-icon-outline').classList.add('hidden');
                        btn.querySelector('.bookmark-icon-filled').classList.remove('hidden');
                        btn.classList.add('bookmarked');
                    }
                }
            } catch (error) {
                console.error('Error checking bookmark status:', error);
            }
        }
    }
</script>
<div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col space-y-2">
</div>
{% endblock %}